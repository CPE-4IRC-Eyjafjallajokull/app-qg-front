# ==============================================================================
# OWASP ZAP DAST - Next.js Application
# ==============================================================================
# Analyse DAST (Dynamic Application Security Testing) pour d√©tecter :
# - Vuln√©rabilit√©s web (XSS, CSRF, injections SQL, etc.)
# - Probl√®mes de configuration (headers de s√©curit√©, cookies, etc.)
# - Failles OWASP Top 10
#
# L'application Next.js est d√©marr√©e en local sur le port 3000
# ZAP scanne uniquement localhost (pas de scan de production)
# R√©sultats archiv√©s en tant qu'artifacts et potentiellement en issues GitHub
# ==============================================================================

name: OWASP ZAP DAST

on:
  # D√©clenche le scan baseline sur chaque push (rapide, non-invasif)
  push:
    branches: [main, develop]
  
  # D√©clenche le scan baseline sur les pull requests
  pull_request:
    branches: [main, develop]
  
  # Scan complet planifi√© (chaque mardi √† 3h UTC)
  schedule:
    - cron: "0 3 * * 2"
  
  # Permet le d√©clenchement manuel (scan complet)
  workflow_dispatch:

jobs:
  zap-scan:
    name: Scan DAST OWASP ZAP
    runs-on: ubuntu-latest
    timeout-minutes: 30
    
    # Permissions minimales
    permissions:
      contents: read         # Lecture du code source
      issues: write          # Cr√©ation d'issues pour les alertes (optionnel)
      security-events: write # √âcriture des alertes SARIF (optionnel)
    
    steps:
      # ========================================
      # 1. R√©cup√©ration du code source
      # ========================================
      - name: Checkout du d√©p√¥t
        uses: actions/checkout@v4

      # ========================================
      # 2. V√©rification de docker-compose.yml
      # ========================================
      - name: D√©tection de docker-compose.yml
        id: check-compose
        run: |
          if [ -f "docker-compose.yml" ]; then
            echo "compose_exists=true" >> $GITHUB_OUTPUT
            echo " docker-compose.yml d√©tect√© - build avec Docker"
          else
            echo "compose_exists=false" >> $GITHUB_OUTPUT
            echo " Pas de docker-compose.yml - build avec npm"
          fi

      # ========================================
      # 3a. Build et d√©marrage avec Docker Compose
      # ========================================
      - name: D√©marrage avec Docker Compose
        if: steps.check-compose.outputs.compose_exists == 'true'
        run: |
          # Variables minimales pour le build Next.js
          cat > .env << EOF
          NODE_ENV=production
          NEXT_PUBLIC_APP_VERSION=ci-scan
          API_URL=http://localhost:8000
          KEYCLOAK_ISSUER=http://localhost:8080/realms/dummy
          KEYCLOAK_CLIENT_ID=dummy
          KEYCLOAK_CLIENT_SECRET=dummy
          NEXTAUTH_SECRET=dummy-secret-for-ci-scan-only
          NEXTAUTH_URL=http://localhost:3000
          AUTH_TRUST_HOST=true
          EOF
          
          # Build et d√©marrage en arri√®re-plan
          docker compose up -d --build
          
          echo " Attente du d√©marrage de l'application..."
          sleep 15

      # ========================================
      # 3b. Build et d√©marrage avec npm (fallback)
      # ========================================
      - name: Installation de Node.js
        if: steps.check-compose.outputs.compose_exists == 'false'
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Installation des d√©pendances npm
        if: steps.check-compose.outputs.compose_exists == 'false'
        run: npm ci

      - name: Build de l'application Next.js
        if: steps.check-compose.outputs.compose_exists == 'false'
        run: npm run build
        env:
          NODE_ENV: production
          NEXT_PUBLIC_APP_VERSION: ci-scan

      - name: D√©marrage de l'application Next.js
        if: steps.check-compose.outputs.compose_exists == 'false'
        run: |
          # D√©marrage en arri√®re-plan et sauvegarde du PID
          npm run start &
          echo $! > .nextjs.pid
          echo " Attente du d√©marrage de l'application..."
          sleep 15
        env:
          PORT: 3000
          NODE_ENV: production

      # ========================================
      # 4. V√©rification de la disponibilit√© de l'app
      # ========================================
      - name: V√©rification de la disponibilit√© (http://localhost:3000)
        run: |
          echo " Test de connexion √† l'application..."
          timeout 90 bash -c '
            until curl -f -s -o /dev/null http://localhost:3000; do
              echo "En attente de http://localhost:3000..."
              sleep 3
            done
          '
          echo " Application Next.js disponible sur http://localhost:3000"

      # ========================================
      # 5. Scan OWASP ZAP Baseline (rapide, non-invasif)
      # ========================================
      - name: OWASP ZAP - Baseline Scan
        if: github.event_name == 'push' || github.event_name == 'pull_request'
        uses: zaproxy/action-baseline@v0.12.0
        with:
          target: 'http://localhost:3000'
          # Fichier de r√®gles pour ignorer certains faux positifs
          rules_file_name: '.zap/rules.tsv'
          # Options :
          #   -a = mode automatique (pas d'interaction)
          #   -j = format JSON
          #   -l WARN = niveau de log
          cmd_options: '-a -j -l WARN'
          # G√©n√®re une issue GitHub avec les r√©sultats
          issue_title: 'ZAP Baseline Scan - R√©sultats de s√©curit√©'
          # Ne fait PAS √©chouer le pipeline (fail_action: false)
          fail_action: false

      # ========================================
      # 6. Scan OWASP ZAP Full (complet, invasif)
      # ========================================
      # Ex√©cut√© uniquement sur :
      #  - Planification hebdomadaire (schedule)
      #  - D√©clenchement manuel (workflow_dispatch)
      - name: OWASP ZAP - Full Scan
        if: github.event_name == 'schedule' || github.event_name == 'workflow_dispatch'
        uses: zaproxy/action-full-scan@v0.10.0
        with:
          target: 'http://localhost:3000'
          rules_file_name: '.zap/rules.tsv'
          cmd_options: '-a -j -l WARN'
          issue_title: 'ZAP Full Scan - R√©sultats de s√©curit√©'
          fail_action: false

      # ========================================
      # 7. Archivage des rapports ZAP
      # ========================================
      - name: Sauvegarde des rapports ZAP
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: zap-scan-reports
          path: |
            report_html.html
            report_json.json
            report_md.md
          retention-days: 30
          if-no-files-found: warn

      # ========================================
      # 8. Arr√™t de l'application
      # ========================================
      - name: Arr√™t de l'application (Docker Compose)
        if: always() && steps.check-compose.outputs.compose_exists == 'true'
        run: docker compose down

      - name: Arr√™t de l'application (npm)
        if: always() && steps.check-compose.outputs.compose_exists == 'false'
        run: |
          if [ -f .nextjs.pid ]; then
            kill $(cat .nextjs.pid) || true
            rm .nextjs.pid
          fi

      # ========================================
      # 9. Cr√©ation d'une issue GitHub si probl√®mes critiques
      # ========================================
      - name: Cr√©ation d'issue GitHub pour les alertes critiques
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // V√©rifier si le rapport Markdown existe
            if (fs.existsSync('report_md.md')) {
              const report = fs.readFileSync('report_md.md', 'utf8');
              
              // Cr√©er une issue GitHub avec le rapport
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: ' ZAP DAST - Vuln√©rabilit√©s d√©tect√©es',
                body: `##  Rapport de scan OWASP ZAP\n\n${report}\n\n---\n\n** Date du scan :** ${new Date().toISOString()}\n**üåø Branche :** \`${context.ref}\`\n**üîó Workflow :** [${context.workflow}](${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})`,
                labels: ['security', 'zap-dast', 'vulnerability']
              });
              
              core.info(' Issue GitHub cr√©√©e avec les r√©sultats du scan');
            } else {
              core.warning(' Aucun rapport ZAP trouv√©');
            }
